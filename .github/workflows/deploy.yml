name: WebGL을 itch.io에 배포하기

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Git LFS pull
        run: git lfs pull

      # Unity 프로젝트 빌드 (Personal License .ulf 사용)
      - name: Unity 프로젝트 빌드 (WebGL)
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}   # .ulf 원문(UTF-8) 전체
        with:
          unityVersion: 2022.3.22f1
          targetPlatform: WebGL
          projectPath: "Last Breath of Terra"   # 공백 포함된 프로젝트 폴더명
          buildsPath: Build
          customParameters: -logFile /github/workspace/EditorCI.log

      # Unity 로그 tail 출력 (실패 시 콘솔에서 바로 확인)
      - name: Show Editor log tail
        if: always()
        run: |
          echo "===== EditorCI.log (last 200 lines) ====="
          (tail -n 200 /github/workspace/EditorCI.log || echo "EditorCI.log not found")
          echo "========================================="

      # 빌드 산출물 업로드 (Artifacts)
      - name: Upload build
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: WebGL_Build
          path: "Last Breath of Terra/Build/WebGL"
          if-no-files-found: warn

      # 전체 Unity 로그 업로드
      - name: Upload Editor log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: EditorCI_log
          path: /github/workspace/EditorCI.log
          if-no-files-found: ignore

      # Unity 라이선스 반환
      - name: Return Unity license
        if: always()
        uses: game-ci/unity-return-license@v2

      # 성공 시 itch.io에 배포
      - name: Deploy to itch.io
        if: success()
        run: |
          set -euxo pipefail
          curl -L -o butler.zip https://broth.itch.ovh/butler/linux-amd64/LATEST/archive/default
          unzip -q butler.zip -d butler
          chmod +x butler/butler
          butler/butler push "Last Breath of Terra/Build/WebGL" "PotatoTeam/attis:WebGL" --api-key="${{ secrets.ITCHIO_API_KEY }}"
