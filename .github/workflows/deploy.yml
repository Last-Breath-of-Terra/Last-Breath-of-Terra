name: WebGL을 itch.io에 배포하기

on:
push:
branches: [ main ]
workflow_dispatch:

jobs:
deploy:
runs-on: ubuntu-latest

steps:
  - name: Checkout
    uses: actions/checkout@v4
    with:
      lfs: true

  - name: Git LFS pull
    run: git lfs pull
  
  # Unity 라이선스 활성화 (계정 정보 사용)
  - name: Activate Unity License
    uses: game-ci/unity-activate@v2
    env:
      UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
      UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}

  # Unity 빌드
  - name: Build WebGL with Unity
    uses: game-ci/unity-builder@v4
    with:
      unityVersion: 2022.3.22f1
      targetPlatform: WebGL
      projectPath: "Last Breath of Terra"
      buildsPath: Build
      customParameters: >
        -logFile /github/workspace/EditorCI.log
        -quit -batchmode
        -executeMethod BuildScript.BuildWebGL

  # 실패해도 콘솔에서 바로 로그 확인
  - name: Show Editor log tail
    if: always()
    run: |
      echo "===== EditorCI.log (last 200 lines) ====="
      (tail -n 200 /github/workspace/EditorCI.log || echo "EditorCI.log not found")
      echo "========================================="

  # 빌드 산출물/로그 업로드
  - name: Upload WebGL build
    if: always()
    uses: actions/upload-artifact@v4
    with:
      name: WebGL_Build
      path: "Last Breath of Terra/Build/WebGL"
      if-no-files-found: warn

  - name: Upload Editor log
    if: always()
    uses: actions/upload-artifact@v4
    with:
      name: EditorCI_log
      path: /github/workspace/EditorCI.log
      if-no-files-found: ignore

  # 라이선스 반환 (필수)
  - name: Return Unity license
    if: always()
    uses: game-ci/unity-return-license@v2

  # 성공 시 itch.io 배포
  - name: Deploy to itch.io
    if: success()
    run: |
      set -euxo pipefail
      curl -L -o butler.zip https://broth.itch.ovh/butler/linux-amd64/LATEST/archive/default
      unzip -q butler.zip -d butler
      chmod +x butler/butler
      butler/butler push "Last Breath of Terra/Build/WebGL" "PotatoTeam/attis:WebGL" --api-key="${{ secrets.ITCHIO_API_KEY }}"
